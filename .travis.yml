#
# Archivo de configuración de Travis.
# Proyecto Lovelace.
#

# Configuración general #######################################################

language: cpp
compiler:
  - gcc

matrix:
  include:
    - os: linux
      addons:
        mariadb: '10.1'
        apt:
          sources:
            - ubuntu-toolchain-r-test
          packages:
            - g++-7
      env:
        - MATRIX_EVAL="CC=gcc-7 && CXX=g++-7"

# Determinan el entorno: ubuntu trusty (14.04)
sudo: required
dist: trusty

# Instalación de dependencias #################################################
before_install:
  - eval "${MATRIX_EVAL}"
  - sudo apt-get -qq update
  - sudo apt-get -qq install
    libmysqlcppconn-dev
    yasm
  # Cryptopp
  - wget --quiet https://cryptopp.com/cryptopp600.zip
  - unzip --qq -a -d cryptopp cryptopp600.zip
  - make -C cryptopp
  - sudo mkdir /usr/include/cryptopp
  - sudo mv cryptopp/*.h /usr/include/cryptopp/
  - sudo mv cryptopp/libcryptopp.a /usr/lib/

install:
  - eval "${MATRIX_EVAL}"
  - make -C pruebas_librerias
  - make -C implementaciones
  - make -C implementaciones binarios/lovelace
  - make -C implementaciones binarios/pruebas_desempenio
  - make -C utilidades
  - cd bases_de_datos
  - chmod 770 crear_base.sh
  - chmod 770 crear_estructura.sh
  - sudo ./crear_base.sh
  - ./crear_estructura.sh
  - cd ..

script:
  - eval "${MATRIX_EVAL}"
# - make -C pruebas_librerias correr
  - make -C implementaciones correr
  - make -C utilidades correr
  - cd implementaciones
  - chmod 770 lovelace_prueba.sh
  - ./lovelace_prueba.sh 100
  - cd ..
  - bash -v travis/pruebas_desempenio.sh

# Generación de documentación #################################################
after_success:
  - bash -v travis/dependencias_distribucion.sh
  - export PATH=~/ejecutable_biber/:$PATH
  # Compilación de archivos de LaTeX
  - make -B -C documentos_entregables
  - make -B -C documentos_entregables presentacion_fpe/presentacion_fpe.pdf
  - make -B -C documentos_entregables
    presentacion_tt_uno/presentacion_tt_uno.pdf
  #- make -B -C documentos_entregables
  #  articulo/articulo.pdf
  # Documentación.
  - make documentación_doxygen
  - make -C pagina_publica/documentacion_doxygen/latex

# Despliegue #################################################################
# Antes del despliegue
before_deploy:
  - mv README.md pagina_publica/
#  - mv reglas_de_estilo.md pagina_publica/
  - mkdir -p pagina_publica/documentos_entregables/reporte_tecnico
  - mv documentos_entregables/reporte_tecnico/reporte_tecnico.pdf
    pagina_publica/documentos_entregables/reporte_tecnico/
  - mkdir -p pagina_publica/documentos_entregables/presentacion_fpe
  - mv documentos_entregables/presentacion_fpe/presentacion_fpe.pdf
    pagina_publica/documentos_entregables/presentacion_fpe/
  - mkdir -p pagina_publica/documentos_entregables/presentacion_tt_uno
  - mv documentos_entregables/presentacion_tt_uno/presentacion_tt_uno.pdf
    pagina_publica/documentos_entregables/presentacion_tt_uno/
  - mkdir -p pagina_publica/documentos_entregables/articulo
  #- mv documentos_entregables/articulo/articulo.pdf
  #  pagina_publica/documentos_entregables/articulo/

# Fase de despliegue
deploy:
  provider: pages
  skip-cleanup: true
  github-token: $GITHUB_TOKEN
  local_dir: pagina_publica
  keep-history: true
  name: RQF7_bot
  verbose: true
  on:
    branch: master
