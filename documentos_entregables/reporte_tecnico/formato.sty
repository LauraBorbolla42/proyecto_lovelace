%
% Especificación de formato y plantillas para documento final.
% Proyecto Lovelace.
%

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{reporte_tecnico/formato}
  [2017/10/13 Paquete para formato de documento de TT]

% Dependencias de librerías.

% http://ftp.math.purdue.edu/mirrors/ctan.org/macros/latex/contrib/
% morewrites/morewrites.pdf
% Permite abrir más archivos para escritura.
\RequirePackage{morewrites}

% http://mirrors.ctan.org/macros/latex/required/graphics/grfguide.pdf
\RequirePackage{graphicx}

% http://mirrors.ctan.org/macros/latex/contrib/float/float.pdf
\RequirePackage{float}

% http://mirrors.ctan.org/macros/latex/contrib/fancyhdr/fancyhdr.pdf
\RequirePackage{fancyhdr}

% http://mirrors.ctan.org/macros/latex/contrib/xcolor/xcolor.pdf
\RequirePackage{xcolor}

% http://mirrors.ctan.org/macros/latex/contrib/titlesec/titlesec.pdf
\RequirePackage[nobottomtitles*]{titlesec}

% http://mirrors.ctan.org/macros/latex/required/amsmath/amsmath.pdf
\RequirePackage{amsmath}

% http://ctan.math.illinois.edu/fonts/amsfonts/doc/amssymb.pdf
% Simbología extra.
\RequirePackage{amssymb}

% http://ctan.math.washington.edu/tex-archive/macros/latex/required/
% psnfss/psnfss2e.pdf
% Simbología extra.
\RequirePackage{pifont}

% http://mirrors.ctan.org/macros/latex/contrib/lastpage/lastpage.pdf
\RequirePackage{lastpage}

% http://mirrors.ctan.org/macros/latex/contrib/caption/caption-eng.pdf
\RequirePackage{caption}

% http://mirrors.ctan.org/macros/latex/contrib/caption/subcaption.pdf
\RequirePackage{subcaption}

% http://mirrors.rit.edu/CTAN/macros/latex/contrib/bold-extra/bold-extra.pdf
% Funtes smallcaps en negritas.
\RequirePackage{bold-extra}

% http://mirrors.concertpass.com/tex-archive/macros/latex/
% contrib/subfig/subfig.pdf
% Figuras con subfiguras
% \RequirePackage{subfig}
% ... No es compatible con subcaption

% http://mirrors.ctan.org/macros/latex/contrib/hyperref/doc/manual.pdf
\RequirePackage{hyperref}
\hypersetup{
  pdftitle={\Titulo},
  pdfsubject={\Subtitulo},
  bookmarksnumbered=true,
  bookmarksopen=truef
  bookmarksopenlevel=1,
  pdfstartview=Fit,
  pdfpagemode=UseOutlines,
  linktocpage=true,
  breaklinks=true,
  linkbordercolor=white,
  citebordercolor=white,
  filebordercolor=white,
  menubordercolor=white,
  urlbordercolor=white,
  pdfborder={0 0 0},
  frenchlinks}

% Caracteres de salto de línea en URLs:
% \def\UrlBreaks{\do\/\do-\do p}

% http://mirrors.ctan.org/macros/latex/contrib/oberdiek/bookmark.pdf
\RequirePackage{bookmark}

% http://mirrors.ctan.org/macros/latex/contrib/listings/listings.pdf
\RequirePackage{listings}

% http://mirrors.ctan.org/macros/latex/contrib/glossaries/glossariesbegin.pdf
\RequirePackage[acronym,
                section=section
                ]{glossaries}

% Glosarios sin secciones
\renewcommand{\glossarysection}[2][]{}

% Resetar la bandera de primer uso al ocurrir estos comandos.
% https://tex.stackexchange.com/questions/153492/glossaries-emphasize-first-
% occurrence-of-every-section#153494
\pretocmd{\chapter}{\glsresetall}{}{}
\pretocmd{\section}{\glsresetall}{}{}
\pretocmd{\subsection}{\glsresetall}{}{}

% http://mirrors.ctan.org/fonts/amsfonts/doc/amsfndoc.pdf
\RequirePackage{amsfonts}

% http://mirrors.ctan.org/fonts/amsfonts/doc/amsfndoc.pdf
\RequirePackage{array}

% Centrado de celdas en tablas con ancho:
% https://tex.stackexchange.com/questions/157389/how-to-center-column-
% values-in-a-table
\newcolumntype{P}[1]{>{\centering\arraybackslash}p{#1}}

% http://mirrors.ctan.org/macros/latex/contrib/makecell/makecell.pdf
\RequirePackage{makecell}

% http://mirrors.ctan.org/macros/latex/contrib/changepage/changepage.pdf
\RequirePackage{changepage}

% http://mirrors.ctan.org/macros/latex/contrib/hanging/hanging.pdf
\RequirePackage{hanging}                    % Indentación personalizada.

% http://mirrors.ctan.org/macros/latex/contrib/enumitem/enumitem.pdf
% Controla el aspecto de las listas, las enumeraciones y las descripciones
\RequirePackage{enumitem}
\setenumerate
{
  topsep=0pt,
  leftmargin=2em
}

% http://mirrors.ctan.org/macros/latex/required/tools/longtable.pdf
% Permite que haya tablas distribuidas en varias páginas
\RequirePackage{longtable}

% http://mirrors.ctan.org/macros/latex/contrib/geometry/geometry.pdf
\RequirePackage[letterpaper,                % Tamaño
                textwidth=7in,              % Ancho
                textheight=9.0in,           % Alto
                top=1.0in,
                bindingoffset=6mm
                ]{geometry}                 % Márgenes

% Nota sobre geometry:
% Un binding offset de 6mm parece dejar los márgenes iguales para
% páginas pares e impares (no lo entiendo, simplemente me lo dijo
% tex.stackexchange), creo que ya que vayamos a imprimir es una buena idea
% leer la documentación
% http://texdoc.net/texmf-dist/doc/latex/geometry/geometry.pdf

% http://ctan.mirrors.hoobly.com/macros/latex/contrib/showlabels/showlabels.pdf
% Muestra \labels en el pdf.
%\usepackage[inline]{showlabels}

% http://mirrors.ctan.org/macros/latex/required/tools/multicol.pdf
% Crea celdas a lo largo de varias columnas.
\RequirePackage{multicol}

% http://mirrors.ctan.org/macros/latex/contrib/multirow/multirow.pdf
% Crea celdas a lo largo de varias filas.
\RequirePackage{multirow}

% http://mirrors.ibiblio.org/CTAN/macros/latex/required/graphics/rotating.pdf
% Harramientas para rotar floats.
\RequirePackage{rotating}

% https://www.ctan.org/pkg/pgf
% Gráficos desde LaTeX
\usepackage{tikz}
\usetikzlibrary{
  arrows.meta,
  decorations.pathmorphing,
  backgrounds,
  positioning,
  calc,
  scopes,
  shapes,
  er}

\tikzset{
  font=\footnotesize}

% http://perso.ensta-paristech.fr/~kielbasi/tikzuml/
% var/files/html/web-tikz-uml-userguide.html#t-3
% Diagramas uml con tikz
\RequirePackage{tikz-uml}

\tikzumlset{
  fill object = white,
  fill package = white,
  fill class = white,
  font = \tiny}

% http://mirrors.ctan.org/macros/latex/contrib/csquotes/csquotes.pdf
% Permite definir el tipo de comillas dependiendo el contexto.
\RequirePackage[style=spanish]{csquotes}

% http://ctan.math.washington.edu/tex-archive/macros/generic/dirtree/dirtree.pdf
% Diagramas de estructura de archivos.
\RequirePackage{dirtree}

% http://ctan.mirrors.hoobly.com/macros/latex/contrib/varwidth/varwidth-doc.pdf
% Parecido a minipage, pero con ancho automático.
\RequirePackage{varwidth}

% http://mirrors.sorengard.com/ctan/macros/latex/contrib/minted/minted.pdf
% Inserción de código.
\RequirePackage{minted}

% Estilo
\usemintedstyle{bw}

% Configuraciones globales.
\setminted{
  framesep=2mm,
  frame=lines,
  baselinestretch=1.0,
  fontsize=\scriptsize,
  linenos,
  numbersep=6pt,
  samepage=true}

% http://ctan.math.washington.edu/tex-archive/macros/latex/contrib/
% epigraph/epigraph.pdf
% Para mostrar epígrafes.
\RequirePackage{epigraph}

% Configuración del aspecto de los epígrafes
\renewcommand{\textflush}{flushright}
\renewcommand{\epigraphflush}{center}
\renewcommand{\epigraphsize}{\normalsize}
\setlength{\epigraphrule}{0pt}

% http://mirror.utexas.edu/ctan/macros/latex/contrib/appendix/appendix.pdf
% Gestión de apéndices
\RequirePackage{appendix}

% http://ctan.math.utah.edu/ctan/tex-archive/macros/latex/contrib/
% enumitem/enumitem.pdf
% Control sobre aspecto de listas numeradas.
\RequirePackage{enumitem}

\RequirePackage{verbatim}

\RequirePackage{ifthen}

% Profundidad de contador
% Hasta subsubsecciones
\setcounter{secnumdepth}{2}

% Formato de párrafos
\setlength{\parindent}{2em}                 % Sangría
\setlength{\parskip}{1em}                   % Espacio entre párrafos
\renewcommand{\baselinestretch}{1.25}       % Interlineado

% Formato de títulos
\titleformat{\chapter}[display]
{\bfseries\Huge\centering}                  % Formato
{\chaptertitlename \ \thechapter}           % Etiqueta
{0.5ex}                                     % Separación
{}                                          % Antes de
[]                                          % Después de

\titleclass{\part}{top}
\titleformat{\part}[display]
{\bfseries\Huge\centering}                  % Formato
{\partname \ \thepart}                      % Etiqueta
{0.5ex}                                     % Separación
{}                                          % Antes de
[]                                          % Después de

%\titleformat{\subsection}[hang]
%{\normalfont\large\bfseries}
%{\thesubsection}{1em}
%{}
%[]
%
%\titleformat{\subsubsection}[hang]
%{\normalfont\large\bfseries}
%{\thesubsubsection}{1em}
%{}
%[]

% izquierda, arriba, abajo
\titlespacing*{\section}{0pc}{0pc}{0pc}
\titlespacing*{\subsection}{0pc}{1pc}{0pc}
\titlespacing*{\subsubsection}{0pc}{1pc}{0pc}

% Secciones en nueva página
% \newcommand{\sectionbreak}{\clearpage}

% Espaciado en floats H (arriba y abajo)
\setlength{\intextsep}{1em}                 % Con H
\setlength{\textfloatsep}{1em}              % Con T y B
% https://tex.stackexchange.com/questions/36361/how-can-i-inject-the-proper-
% amount-of-vertical-space-between-captions-and-figure/36362#comment72508_36362


% Encabezado y pie
% Parámetros de fancyhead y fancyfoot:
% C (center), L (left), R (right)
% E (even), O (odd)
\fancypagestyle{contenido} {
  \fancyhf{}
  \fancyhead[CE]{\Titulo}                   % Centro arriba par
  \fancyhead[CO]{\nouppercase\leftmark}     % Centro arriba impar
  \fancyfoot[LE, RO]{Página \thepage \
     de \pageref{LastPage}}                 % Derecha abajo
  \fancyfoot[RE, LO]{\Subtitulo}            % Izquierda abajo
  \renewcommand{\headrulewidth}{0.4pt}      % Línea encabezado
  \renewcommand{\footrulewidth}{0.4pt}}     % Línea pie


% Estilo de páginas previas al primer capítulo
\fancypagestyle{intro} {
  \fancyhf{}
  \fancyhead[CE, CO]{\Titulo}
  \fancyfoot[LE, RO]{Página \thepage}
  \fancyfoot[RE, LO]{\Subtitulo}
  \renewcommand{\headrulewidth}{0.4pt}
  \renewcommand{\footrulewidth}{0.4pt}}

% 0.4pt es el equivalente de \thin en tikz. Este es el grosor
% por defecto utilizado en los diagramas.

% El entorno «plain» es el que utilizan las página de los capítulos
% Se redefine para que no tengan ni pie ni encabezado.
\fancypagestyle{plain} {
  \fancyfoot[LE, RO]{}
  \fancyfoot[LO, RE]{}
  \fancyhead[CE, CO]{}
  \renewcommand{\headrulewidth}{0.0pt}
  \renewcommand{\footrulewidth}{0.0pt}}

% Alto de celdas de tablas
%\renewcommand{\arraystretch}{1.8}

% Cambios en las traducciones de babel
\addto\captionsspanish{
  \renewcommand*\contentsname{Índice}
  \renewcommand*\listfigurename{Lista de figuras}
  \renewcommand*\tablename{Tabla}
  \renewcommand*\listtablename{Lista de tablas}
  \renewcommand*{\lstlistlistingname}{Lista de pseudocódigos}
  \renewcommand*{\seename}{véase también}   % En entradas de glosario
  \renewcommand*{\andname}{y}               % En listas de referencias cruzadas.
  \renewcommand*\appendixname{Apéndice}
  \renewcommand*\appendixtocname{Apéndice}
  \renewcommand*\appendixpagename{Apéndices}}

% Babel no define traducciones para esto. Por eso están afuera.
\renewcommand\listingscaption{Código fuente}
\renewcommand\listoflistingscaption{Lista de códigos fuentes}

% Información de latex
\title{\Titulo{}}
\author{\Autor{}}
\date{\today}

% Buffer temporal:
\newcommand{\etiqueta}{}

% Archivos de plantillas
\import{reporte_tecnico/plantillas/}{unidad_irrompible.sty}
\import{reporte_tecnico/plantillas/}{hipervinculo.sty}
\import{reporte_tecnico/plantillas/}{formato_numeros.sty}
\import{reporte_tecnico/plantillas/}{portada.sty}
\import{reporte_tecnico/plantillas/}{pseudocodigo.sty}
\import{reporte_tecnico/plantillas/}{dependencia.sty}
\import{reporte_tecnico/plantillas/}{parte.sty}
\import{reporte_tecnico/plantillas/}{capitulo.sty}
\import{reporte_tecnico/plantillas/}{epigrafe.sty}
\import{reporte_tecnico/plantillas/}{expresion_regular.sty}
\import{reporte_tecnico/plantillas/}{celda_con_parrafo.sty}
\import{reporte_tecnico/plantillas/}{codigo_fuente.sty}
\import{reporte_tecnico/plantillas/}{parrafo_con_lista_corta.sty}
\import{reporte_tecnico/plantillas/ingenieria_de_software/}
  {ingenieria_de_software.sty}

% Archivo con entradas del glosario
\input{reporte_tecnico/contenidos/glosario.tex}

% Archivo con definición de siglas
\input{reporte_tecnico/contenidos/siglas_y_acronimos/siglas_y_acronimos.tex}

\makeatletter

  % Redefinición de listas y de bibliografía.
  % Se hacen secciones en lugar de capítulos.

  \renewcommand\listoffigures{%
    \section*{\listfigurename}%
      \@mkboth{\MakeUppercase\listfigurename}%
              {\MakeUppercase\listfigurename}%
    \@starttoc{lof}}

  \renewcommand\listoftables{%
    \section*{\listtablename}%
      \@mkboth{\MakeUppercase\listtablename}%
              {\MakeUppercase\listtablename}%
    \@starttoc{lot}}

  \renewcommand\lstlistoflistings{%
    \section*{\lstlistlistingname}%
      \@mkboth{\MakeUppercase\lstlistlistingname}%
              {\MakeUppercase\lstlistlistingname}%
    \@starttoc{lol}}

  \renewcommand\tableofcontents{%
    \section*{\contentsname}%
      \@mkboth{\MakeUppercase\contentsname}%
              {\MakeUppercase\contentsname}%
    \@starttoc{toc}}

  % Redefinir hypertarget para guardar referencia en .aux
  \let\hypertargetanterior\hypertarget
  \renewcommand{\hypertarget}[2]{%
    \hypertargetanterior{#1}{#2}%
    \protected@write\@mainaux{}{%
      \string\expandafter\string\gdef%
      \string\csname\string\detokenize{#1}\string\endcsname{#2}}}

  % Redefinición de lista de referencias cruzadas para el glosario:
  % solamente se agrega el punto final.
  \renewcommand*{\glsseeformat}[3][\seename]{\emph{#1 }\glsseelist{#2}.}

  % Nombres de entradas en glosario con primera letra en mayúscula.
  \renewcommand{\glsnamefont}[1]{\makefirstuc{#1}}

  % Redefinición de «claerdoublepage» para que las páginas en blanco no
  % tengan encabezado ni pie.
  \def\cleardoublepage{\clearpage\if@twoside \ifodd\c@page\else%
   \hbox{}\thispagestyle{empty}\newpage\if@twocolumn\hbox{}\newpage\fi\fi\fi}

  % Redefinición de frontmatter y mainmatter
  \renewcommand{\frontmatter}{
    \cleardoublepage%
    \@mainmatterfalse%
    \pagenumbering{Roman}%
    \pagestyle{intro}}

  \renewcommand{\mainmatter}{%
    \cleardoublepage%
    \@mainmattertrue%
    \pagenumbering{arabic}%
    \pagestyle{contenido}}

  % Para poder centrar una columna especifica en una tabla.
  \newcolumntype{C}[1]{>{\centering\let\newline\\\arraybackslash\hspace{0pt}}m{#1}}

  % Modifica el posicionamiento de los listings de minted
  \renewcommand{\fps@listing}{htp}

  % Redefinición de los epígrafes para aumentar el espaciado entre cita y
  % fuente.
  \renewcommand{\epigraph}[2]{\vspace{\beforeepigraphskip}
    {\epigraphsize\begin{\epigraphflush}\begin{minipage}{\epigraphwidth}%
      \@epitext{#1}\\ \vspace{0.8em}\\ \@episource{#2}%
      \end{minipage}\end{\epigraphflush}%
      \vspace{\afterepigraphskip}}}

  % Redefinición de entradas de capítulos en tabla de contenidos.
  % En lugar de «\penalty\@highpenalty», después de la línea producto,
  % ocupo «\nopagebreak[4]».
  % No estoy muy seguro de cuál es la diferencia (se supone que la
  % penalización más alta es 4), el caso es que la segunda funciona:
  % no se deja que haya un salto de página después de la entrada de un
  % capítulo.
  %
  % La definición original salió de:
  % /usr/share/texmf-dist/tex/latex/base/book.cls
  \renewcommand*\l@chapter[2]{%
    \ifnum \c@tocdepth >\m@ne
      %\addpenalty{-\@highpenalty}%
      \vskip 1.0em \@plus\p@
      \setlength\@tempdima{1.5em}%
      \begingroup
        \parindent \z@ \rightskip \@pnumwidth
        \parfillskip -\@pnumwidth
        \leavevmode \bfseries
        \advance\leftskip\@tempdima
        \hskip -\leftskip
        #1\nobreak\hfil \nobreak\hb@xt@\@pnumwidth{\hss #2}\par
        \nopagebreak[4]
        %\penalty\@highpenalty
      \endgroup
    \fi}

    % Sin saltos de página después de títulos
    % (No funciona); se ocupa titlesec

    %\let\subsectionAnterior\subsection
    %\renewcommand{\subsection}[1]{%
    %  \pagebreak[3]%
    %  \subsectionAnterior{#1}%
    %  \nopagebreak[4]}

    %\let\subsubsectionAnterior\subsubsection
    %\renewcommand{\subsubsection}[1]{%
    %  \pagebreak[3]%
    %  \subsubsectionAnterior{#1}%
    %  \nopagebreak[4]}

    % Comando para reemplazar los guiones bajos con su correspondiente
    % secuencia de escape.
    % https://tex.stackexchange.com/questions/20890/
    % define-an-escape-underscore-environment
    \DeclareRobustCommand*{\escapeus}[1]{%
    \begingroup\@activeus\scantokens{#1\endinput}\endgroup}
    \begingroup\lccode`\~=`\_\relax
      \lowercase{\endgroup\def\@activeus{\catcode`\_=\active \let~\_}}

\makeatother
