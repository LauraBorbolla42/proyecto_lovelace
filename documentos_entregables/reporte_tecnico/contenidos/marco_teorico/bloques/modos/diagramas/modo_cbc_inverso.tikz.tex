%
% Diagrama de descifrado del modo CBC,
% capítulo de marco teórico.
% Proyeco Lovelace.
%

\begin{tikzpicture}[
  bloque/.style = {
    rectangle,
    draw = black,
    thin,
    align = center,
    inner sep = 4mm},
  combinacion/.style = {
    draw = black,
    thin,
    minimum size = 5mm,
    circle}]

  \node[bloque]
    (e_1)
    {$ D $};
  \draw[-Stealth]
    ($(e_1.west) + (-0.6in, 0.1in)$)
    node[
      anchor = east]
      {$ k $}
    --
    ($(e_1.west) + (0, 0.1in)$);
  \draw[-Stealth]
    ($(e_1.west) + (-0.6in, -0.1in)$)
    node[
      anchor = east]
      {$ Bc_1 $}
    --
    ($(e_1.west) + (0, -0.1in)$);

  \node[combinacion]
    (c_1)
    at ($(e_1.east) + (0.4in + 5mm, 0.0in)$)
    {};
  \draw[-]
    (c_1.north)
    --
    (c_1.south);
  \draw[-]
    (c_1.west)
    --
    (c_1.east);

  \draw[-Stealth]
    (e_1.east)
    --
    (c_1.west);
  \draw[-Stealth]
    (c_1.east)
    --
    ($(c_1.east) + (0.4in, 0)$)
    node[
      anchor = west]
      {$ Bm_1 $};
  \draw[-Stealth]
    ($(c_1.north) + (0, 0.2in)$)
    node[
      anchor = south]
      {$ VI $}
    --
    (c_1.north);

  \node[bloque]
    (e_2)
    [below = 0.3in of e_1]
    {$ D $};
  \draw[-Stealth]
    ($(e_2.west) + (-0.6in, 0.1in)$)
    node[
      anchor = east]
      {$ k $}
    --
    ($(e_2.west) + (0, 0.1in)$);
  \draw[-Stealth]
    ($(e_2.west) + (-0.6in, -0.1in)$)
    node[
      anchor = east]
      {$ Bc_2 $}
    --
    ($(e_2.west) + (0, -0.1in)$);

  \node[combinacion]
    (c_2)
    at ($(e_2.east) + (0.4in + 5mm, 0.0in)$)
    {};
  \draw[-]
    (c_2.north)
    --
    (c_2.south);
  \draw[-]
    (c_2.west)
    --
    (c_2.east);

  \draw[-Stealth]
    (e_2.east)
    --
    (c_2.west);
  \draw[-Stealth]
    (c_2.east)
    --
    ($(c_2.east) + (0.4in, 0)$)
    node[
      anchor = west]
      {$ Bm_2 $};
  \draw[-Stealth]
    ($(e_1.west) + (-0.3in, -0.1in)$)
    --
    ($(e_1.west) + (-0.3in, -0.15in - 5mm)$)
    -|
    (c_2.north);

  \node
    (puntos)
    [below = 0.2in of e_2]
    {$ \dots $};

  \node[bloque]
    (e_n)
    [below = 0.2in of puntos]
    {$ D $};
  \draw[-Stealth]
    ($(e_n.west) + (-0.6in, 0.1in)$)
    node[
      anchor = east]
      {$ k $}
    --
    ($(e_n.west) + (0, 0.1in)$);
  \draw[-Stealth]
    ($(e_n.west) + (-0.6in, -0.1in)$)
    node[
      anchor = east]
      {$ Bc_n $}
    --
    ($(e_n.west) + (0, -0.1in)$);

  \node[combinacion]
    (c_n)
    at ($(e_n.east) + (0.4in + 5mm, 0.0in)$)
    {};
  \draw[-]
    (c_n.north)
    --
    (c_n.south);
  \draw[-]
    (c_n.west)
    --
    (c_n.east);

  \draw[-Stealth]
    (e_n.east)
    --
    (c_n.west);
  \draw[-Stealth]
    (c_n.east)
    --
    ($(c_n.east) + (0.4in, 0)$)
    node[
      anchor = west]
      {$ Bm_n $};

  \draw[-Stealth]
    ($(e_2.west) + (-0.3in, -0.1in)$)
    --
    ($(e_2.west) + (-0.3in, -0.15in - 5mm)$);
  \draw[-Stealth]
    ($(e_2.west) + (-0.3in, -0.6in)$)
    -|
    (c_n.north);

\end{tikzpicture}
