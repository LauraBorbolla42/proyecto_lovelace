%
% Requerimientos de tokens, análisis y diseño de generación de tokens.
% Proyecto Lovelace.
%

\subsection{Requerimientos}
\label{sec:requerimientos}

En \cite{pci_tokens}, el \gls{gl:pci} \gls{gl:ssc} divide a los
\glspl{gl:token} en reversibles e irreversibles. A su vez, los reversibles se
dividen en criptográficos y en no criptográficos; mientras que los
irreversibles se dividen en autenticables y no autenticables (figura
\ref{fig:division_tokens}).

\begin{figure}[H]
  \begin{center}
    \includegraphics[width=0.75\linewidth]{diagramas/clasificacion.png}
    \caption{Clasificación de los \glspl{gl:token}.}
    \label{fig:division_tokens}
  \end{center}
\end{figure}

Los \glspl{gl:token} irreversibles no pueden, bajo ninguna circunstancia, ser
reconvertidos al \gls{gl:pan} original. Esta restricción aplica tanto para
cualquier entidad en el entorno del negocio (comerciante, proveedor de
\glspl{gl:token}, banco) como para cualquier posible atacante. Dados un
\gls{gl:pan} y un \gls{gl:token}, los identificables permiten validar cuando el
primero fue utilizado para la creación del segundo, mientras que los no
identificables, no.

% TODO: ¿Para qué demonios sirven los no identificables?

% TODO: este párrafo me está dando problemas. No quiero copiar tal cuál la
% clasificación del PCI sin manifestar disconformidad, pero tampoco quiero
% entrar en demasiados detalles aún sobre las propias implementaciones
% (las cuales, evidentemente, sí son criptográficas); PD: hay que citar más
% publicaciones, a parte de la de Sandra.

La clasificación del \gls{gl:pci} \gls{gl:ssc} con respecto a los reversibles
resulta un poco confusa (esto ya ha sido señalado antes, \cite{doc_sandra}).
Establece que los criptográficos son generados utilizando
\gls{gl:criptografia_fuerte}, el \gls{gl:pan} nunca se almacena, solamente se
guarda una llave; los no criptográficos guardan la relación entre
\glspl{gl:token} y \gls{gl:pan} en una base de datos. El problema está en que
no se menciona \textit{cómo} generar los no criptográficos. A pesar del nombre,
los métodos más comunes para esta categoría ocupan
\glspl{gl:primitiva_criptografica} (e. g. generadores pseudoaleatorios); además
de que, en una implementación real, para poder cumplir con el \gls{gl:pci}
\gls{gl:dss}, la propia base de datos debe de estar cifrada \cite{pci_dss}.

\gls{gl:pci} \gls{gl:dss} define cuatro \textit{dominios} de seguridad para el
proceso de tokenización:

\begin{enumerate}

  \item \label{dm:gen_tokens} \textbf{Generación de \glspl{gl:token}.}
    Para cada clase tokenizadora, este dominio se encarga de definir
    consideraciones para generación segura de \glspl{gl:token}. Cubre los
    dispositivos, procesos, mecanismos y algoritmos que son utilizados para
    crear los \glspl{gl:token}.

  \item \label{dm:mapeo_tokens} \textbf{Mapeo de \glspl{gl:token}.}
    Este dominio, que se refiere al mapeo de los \glspl{gl:token} con su
    \gls{gl:pan} origen, aplica solamente a los procesos de tokenización
    reversibles. Entre otras cosas, provee guías respecto a control de acceso
    necesarios para las peticiones de tokenización.

  \item \label{dm:card_data} \textbf{Bóveda de datos de tarjeta.}
    Como el dominio pasado, solo aplica a las implementaciones de tokenización
    reversibles. Cubre el cifrado obligado del \gls{gl:pan} y los controles de
    acceso necesarios para entrar a la \gls{gl:cdv}.

  \item \label{dm:man_llaves} \textbf{Manejo criptográfico de llaves.}
    Define las buenas prácticas para el manejo criptográfico de las llaves y
    las operaciones realizadas con ellas por el producto tokenizador.

\end{enumerate}

En esta sección se explica cada una de las categorías y se analizan los
requerimientos que deben tener. Para comenzar, se enlistan los requerimientos
aplicables a todos los \glspl{gl:token}, sin importar su categoría:

% GT1
\requerimiento[rq_pci:productos_de_hardware]
{Validación de productos de hardware}
{
  Si se usa un producto de hardware para la tokenización, este debe de ser
  validado por \gls{gl:fips} 140-2 nivel 3 o superior (descrito en
  \cite{nist_modulos_criptograficos}).
}

% GT2 se lo chutaron.
% GT3
\requerimiento[rq_pci:productos_de_software]
{Validación de productos de software}
{
  Si se usa un producto de software para la tokenización, este debe de ser
  validado por \gls{gl:fips} 140-2 nivel 2 o superior (descrito en
  \cite{nist_modulos_criptograficos}).
}

% GT4
\requerimiento[rq_pci:resistencia_texto_claro_conocido]
{Resistencia a texto claro conocido}
{
  Un atacante con acceso a múltiples pares de \glspl{gl:token} y
  \gls{gl:pan} no debe de ser capaz de determinar otros \gls{gl:pan} a partir
  de solamente \glspl{gl:token}. En otras palabras, los \glspl{gl:token}
  deben ser resistentes a ataques con texto en claro conocido (sección
  \ref{sec:criptoanalisis}).
}

% GT5
% Me parece que esto es reduntante: si GT4 ya estableció la necesidad de
% resistencia a texto claro conocido, la resistencia a sólo texto cifrado
% ya va incluida. De hecho, en la misma redacción de GT5 incluyen claramente
% a GT4 con una disyunción.
% Creo que ya había leído esto mismo en alguno de los artículos que nos pasó
% Sandra.
\requerimiento[rq_pci:resistencia_solo_texto_cifrado]
{Resistencia a sólo texto cifrado}
{
  Recuperar un \gls{gl:pan} a partir de un \gls{gl:token} debe de ser
  \gls{gl:computacionalmente_no_factible} (resistencia a ataques con sólo
  texto cifrado, sección \ref{sec:criptoanalisis}).
}

% GT6
\requerimiento[rq_pci:deteccion_anomalias]
{Detección de anomalías}
{
  Se deben de implementar disparadores que permitan detectar
  irregularidades en el sistema (anomalías, funcionamientos erróneos,
  comportamientos sospechosos). El producto debe registrar dichos eventos y
  avisar al personal correspondiente.
}

% GT7
\requerimiento[rq_pci:distincion_token_pan]
{Distinción entre \glspl{gl:token} y \gls{gl:pan}}
{
  Se debe contar con un mecanismo para distinguir entre \glspl{gl:token}
  y \gls{gl:pan}. Los proveedores del servicio de tokenización deben
  compartir este mecanismo con la entidad (o entidades) que usa los
  \glspl{gl:token}.
}

% GT8
\requerimiento[rq_pci:guia_de_instalacion]
{Guía de instalación}
{
  Se debe de contar con una guía de instalación y uso para el correcto
  funcionamiento del producto de tokenización.
}

% GT9
\requerimiento[rq_pci:integridad_ejecutables]
{Integridad del proceso de tokenización}
{
  Deben de implementarse mecanismos que garanticen la integridad del proceso
  de generación de \glspl{gl:token}.
}

% GT10, RC2A, RN2B y RN3B
\requerimiento[rq_pci:acceso_a_producto]
{Acceso al proceso de tokenización}
{
  Solo los usuarios autenticados y componentes del sistema tienen permitido
  acceder al proceso de tokenización y de-tokenización. Los métodos utilizados
  deben ser al menos tan rigurosos como lo indicado en el requerimiento 8 del
  \gls{gl:pci} \gls{gl:dss} \cite{pci_dss}.

  % GT10.1, RC2A-1, RC2A-2, RN2B, RN3B
  \subrequerimiento[rq_pci:control_de_peticiones]
  {Control de peticiones}
  {
    Todas las peticiones deben pasar a través de una \gls{gl:api} que controle
    todos los intentos de acceso y aplique de manera uniforma reglas de
    control de acceso.
  }

  % GT10.2
  \subrequerimiento[rq_pci:registros_de_acceso]
  {Registros de acceso}
  {
    Se deben registrar todos los eventos de acceso, de tokenización y
    de detokenización. Esta funcionalidad debe ser configurable de manera
    segura. Para esto se debe seguir el requerimiento 4 del
    \gls{gl:pa}-\gls{gl:dss} \cite{dss_pa}.
  }

  % GT10.3
  \subrequerimiento[rq_pci:autenticacion_multifactor]
  {\Gls{gl:autenticacion_multifactor}}
  {
    El sistema debe soportar \gls{gl:autenticacion_multifactor} para todos
    los tipos de usuario: accesos administrativos, operaciones de tokenización
    y detokenización, mantenimiento, etcétera.
  }

  % GT10.4
  \subrequerimiento[rq_pci:acceso_de_sistema]
  {Accesos a nivel de sistema}
  {
    Todos los accesos a nivel de sistema deben soportar
    \gls{gl:autenticacion_mutua}, incluyendo a las peticiones de tokenización
    y detokenización.
  }

  % GT10.5
  \subrequerimiento[rq_pci:acceso_administrativo]
  {Accesos administrativos}
  {
    Se debe utilizar \gls{gl:criptografia_fuerte} para todos los accesos
    administrativos que no se hagan desde consola.
  }
}

% GT11
\requerimiento[rq_pci:token_a_token_prohibido]
{Mapeos de \gls{gl:token} a \gls{gl:token} prohibidos}
{
  No se debe poder pasar de un primer \gls{gl:token} válido a un segundo,
  también válido; forzosamente debe existir un estado intermedio: del primer
  \gls{gl:token} se pasa al \gls{gl:pan} correspondiente (operación de
  detokenización) y de este se pasa al segundo \gls{gl:token}.
}

% GT12
\requerimiento[rq_pci:vulnerabilidades_comunes]
{Protección contra vulnerabilidades comunes}
{
  Se deben implementar medidas en contra de las vulnerabilidades de
  seguridad más comunes (\cite{dss_pa}, requerimiento 5.2). Algunas de estas
  medidas pueden ser el uso de herramientas de análisis de código estático,
  o el uso de lenguajes de programación especializados.
}

% GT13
\requerimiento[rq_pci:primitivas_usadas]
{Primitivas criptográficas usadas}
{
  Las primitivas criptográficas que se usen deben estar basadas en
  estándares nacionales (referentes a Estados Unidos) o internacionales (e. g.
  \gls{gl:aes}). Ver sección \ref{sec:primitivas}.
}

% TODO:
% - Hablar sobre repeticiones en documento de PCI
% - ¿Porqué RC1A no le aplica a los irreversibles también?

% Para eliminar repeticiones:

% IT4A, RC4B, RN4B
\requerimiento[rq_pci:manejo_de_llaves]
{Sobre el manejo adecuado de llaves}
{
  En donde se usen llaves para la generación y protección de \gls{gl:token},
  se deben seguir buenas prácticas criptográficas para la administración de
  estas. En particular, se deben cumplir con las recomendaciones del
  \gls{gl:nist} en \cite{nist_llaves} y \cite{nist_disenio_llaves}.

  % IT4A-1, RC4B-1
  \subrequerimiento[rq_pci:ciclo_de_vida_llaves]
  {Sobre el ciclo de vida}
  {
    La llave tokenizadora debe seguir la política de los ciclos de llaves
    descritos en el \acrshort{gl:iso}/\acrshort{gl:iec} 115681 (ver
    sección \ref{sec:administracion_llaves}).
  }

  % IT4A-2, RC4B-2
  \subrequerimiento[rq_pci:periodo_llaves]
  {Descripción del periodo criptográfico activo}
  {
    La política sobre el tiempo de vida de la llave debe incluir una
    descripción sobre el periodo criptográfico activo de la llave
    tokenizadora en cuestión.
  }

  % IT4A-3, RC4B-3
  \subrequerimiento[rq_pci:destruccion_de_llaves]
  {Sobre la destrucción de las llaves}
  {
   	El proveedor debe incorporar una función que permita la destrucción
   	de sus llaves criptográficas sin tener que alterar o abrir el
   	dispositivo.
  }

  % RC1A-1
  \subrequerimiento[rq_pci:exportar_llaves_en_claro]
  {Exportar llave en claro prohibido}
  {
    Las llaves usadas para generar \glspl{gl:token} no se deben poder
    exportar en claro desde el programa.
  }

  % RC1A-2
  % TODO: ¿Cómo funciona la entropía de una fuente generadora?
  \subrequerimiento[rq_pci:entropia_generacion_llaves]
  {Entropía de generación de llaves}
  {
    La fuente generadora de llaves debe tener, al menos, 128 bits de
    \gls{gl:entropia}.
  }

  % RC1A-3
  \subrequerimiento[rq_pci:llaves_de_uso_unico]
  {Llaves de uso único}
  {
    Las llaves criptográficas usadas para generar \glspl{gl:token} no
    deben ser usadas para ningún otro fin.
  }
}

\subimport{/}{irreversibles}
\subimport{/}{criptograficos_reversibles}
\subimport{/}{no_criptograficos_reversibles}
\subimport{/}{primitivas}

%En la tabla \ref{resumen_general} se clasifican los requerimientos presentados
%hasta ahora. Las categorías posibles son: \textit{aplicables}, \textit{no
%aplicables} y \textit{fuera de alcance}. Los \textit{aplicables} son aquellos
%que  se  encuentran dentro del alcance de este trabajo y que, por lo tanto, son
%adoptados como requerimientos propios. Los \textit{fuera de alcance} se dejan
%fuera por están más allá de las posibilidades de este trabajo.

Los siguientes requerimientos son referentes al cumplimiento
de distintos estándares y recomendaciones (principalmente del \gls{gl:nist});
en la sección \ref{sec:estandares} se resume el contenido de cada uno de
estos:

\begin{itemize}
  \item \hipervinculo{rq_pci:productos_de_hardware}.
  \item \hipervinculo{rq_pci:productos_de_software}.
  \item \hipervinculo{rq_pci:acceso_a_producto}.
  \item \hipervinculo{rq_pci:manejo_de_llaves}.
  \item \hipervinculo{rq_pci:cr_aleatoriedad_digitos}.
\end{itemize}

La tabla \ref{resumen_general} es una relación entre la lista de
requerimientos aquí presentada y la notación del \gls{gl:pci} \gls{gl:ssc} en
\cite{pci_tokens}. Sobre todo en cuanto a los requerimientos
\hipervinculo{rq_pci:acceso_a_producto} y
\hipervinculo{rq_pci:manejo_de_llaves} el documento del \gls{gl:pci} es
bastante repetitivo: se colocan 3 versiones (una para cada categoría) con
prácticamente el mismo contenido.

\begin{longtable}{| m{3.2in} | m{1.4in} | m{1.4in} |}

  \hline
  \textbf{Requerimiento} &
  \textbf{Equivalente \gls{gl:pci}} &
  \textbf{Clasificación} \\
  \hline
  \endfirsthead

  \hline
  \multicolumn{3}{|c|}{\textit{Continuación}}\\
  \hline
  \textbf{Requerimiento} &
  \textbf{Equivalente \gls{gl:pci}} &
  \textbf{Clasificación} \\
  \hline
  \endhead

  \multicolumn{3}{|c|}{\textit{Continúa en siguiente página}}\\
  \hline
  \endfoot

  \endlastfoot

  % Generales:

  \hipervinculo{rq_pci:productos_de_hardware} &
  GT1 &
  Aplicable \\\hline

  \hipervinculo{rq_pci:productos_de_software} &
  GT3 &
  Aplicable \\\hline

  \hipervinculo{rq_pci:resistencia_texto_claro_conocido} &
  GT4 &
  Aplicable \\\hline

  \hipervinculo{rq_pci:resistencia_solo_texto_cifrado} &
  GT5 &
  Aplicable \\\hline

  \hipervinculo{rq_pci:deteccion_anomalias} &
  GT6 &
  Aplicable \\\hline

  \hipervinculo{rq_pci:distincion_token_pan} &
  GT7 &
  Aplicable \\\hline

  \hipervinculo{rq_pci:guia_de_instalacion} &
  GT8 &
  Aplicable \\\hline

  \hipervinculo{rq_pci:integridad_ejecutables} &
  GT9 &
  Aplicable \\\hline

  \hipervinculo{rq_pci:control_de_peticiones} &
  GT10.1, RC2A-1, RC2A-2 RN2B y RN3B &
  Aplicable \\\hline

  \hipervinculo{rq_pci:registros_de_acceso} &
  GT10.2 &
  Aplicable \\\hline

  \hipervinculo{rq_pci:autenticacion_multifactor} &
  GT10.3 &
  Aplicable \\\hline

  \hipervinculo{rq_pci:acceso_de_sistema} &
  GT10.4 &
  Aplicable \\\hline

  \hipervinculo{rq_pci:acceso_administrativo} &
  GT10.5 &
  Aplicable \\\hline

  \hipervinculo{rq_pci:token_a_token_prohibido} &
  GT11 &
  - \\\hline

  \hipervinculo{rq_pci:vulnerabilidades_comunes} &
  GT12 &
  Aplicable \\\hline

  \hipervinculo{rq_pci:primitivas_usadas} &
  GT13 &
  Aplicable \\\hline

  \hipervinculo{rq_pci:ciclo_de_vida_llaves} &
  IT4A-1 y RC4B-1 &
  Aplicable \\\hline

  \hipervinculo{rq_pci:periodo_llaves} &
  IT4A-2 y RC4B-2 &
  Aplicable \\\hline

  \hipervinculo{rq_pci:destruccion_de_llaves} &
  IT4A-3 y RC4B-3&
  Aplicable \\\hline

  \hipervinculo{rq_pci:exportar_llaves_en_claro} &
  RC1A-1 &
  Aplicable \\\hline

  \hipervinculo{rq_pci:entropia_generacion_llaves} &
  RC1A-2 &
  Aplicable \\\hline

  \hipervinculo{rq_pci:llaves_de_uso_unico} &
  RC1A-3 &
  Aplicable \\\hline

  % Irreversibles:

  \hipervinculo{rq_pci:ir_mecanismo_generador} &
  IT1A-1 &
  Aplicable \\\hline

  \hipervinculo{rq_pci:ir_contenido_en_claro} &
  IT1A-2 &
  Aplicable \\\hline

  \hipervinculo{rq_pci:ir_diccionario_imposible} &
  IT1A-3 &
  Aplicable \\\hline

  \hipervinculo{rq_pci:ir_busqueda_exhaustiva} &
  IT1A-4 &
  Aplicable \\\hline

  % Criptográficos:

  \hipervinculo{rq_pci:cr_distribucion_uniforme} &
  RC1B-1 &
  Aplicable \\\hline

  \hipervinculo{rq_pci:cr_permutacion_aleatoria} &
  RC1B-2 &
  Aplicable \\\hline

  \hipervinculo{rq_pci:cr_cambio_de_llave} &
  RC1B-3 &
  Aplicable \\\hline

  \hipervinculo{rq_pci:cr_cambio_de_pan} &
  RC1B-4 &
  Aplicable \\\hline

  \hipervinculo{rq_pci:cr_cambio_de_pan} &
  RC1B-4 &
  Aplicable \\\hline

  \hipervinculo{rq_pci:cr_aleatoriedad_digitos} &
  RC1B-5 &
  Aplicable \\\hline

  \hipervinculo{rq_pci:cr_almacenamiento_tokens} &
  RC1C &
  Aplicable \\\hline

  \hipervinculo{rq_pci:cr_administracion_llaves} &
  RC4A &
  Aplicable \\\hline

  \hipervinculo{rq_pci:cr_longitud_llaves} &
  RC4C &
  Aplicable \\\hline

  \hipervinculo{rq_pci:cr_independencia_estadistica} &
  RC4D &
  Aplicable \\\hline

  % No criptográficos:

  \hipervinculo{rq_pci:nc_generacion_y_almacenamiento} &
  RN1A &
  Aplicable \\\hline

  \hipervinculo{rq_pci:nc_distribucion_equiprobable} &
  RN1B-1 &
  Aplicable \\\hline

  \hipervinculo{rq_pci:nc_permutaciones_aleatorias} &
  RN1B-2 &
  Aplicable \\\hline

  \hipervinculo{rq_pci:nc_parametros_de_tokenizacion} &
  RN1B-3 &
  Aplicable \\\hline

  \hipervinculo{rq_pci:nr_aleatoriedad_digitos} &
  RN1B-5 &
  Aplicable \\\hline

  \hipervinculo{rq_pci:nc_distribucion_imparcial} &
  RN1C &
  Aplicable \\\hline

  \hipervinculo{rq_pci:nc_independencia_estadistica} &
  RN1D &
  Aplicable \\\hline

  \hipervinculo{rq_pci:nc_proceso_detokenizacion} &
  RN2A &
  Aplicable \\\hline

  \hipervinculo{rq_pci:nc_cifrado_de_base} &
  RN3A &
  Aplicable \\\hline

  \hipervinculo{rq_pci:nc_administracion_llaves} &
  RN4A &
  Aplicable \\\hline

  \caption{Resumen de requerimientos del \gls{gl:pci} \gls{gl:ssc} para
    los sistemas tokenizadores.}
  \label{resumen_general}

\end{longtable}
